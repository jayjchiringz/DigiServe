<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DigiServe Dashboard</title>
    {% load static %}
    <link rel="icon" href="{% static 'images/favicon.ico' %}">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<script>
		// Data passed from Django
		const salesLabels = JSON.parse('{{ sales_labels|safe }}');
		const salesData = JSON.parse('{{ sales_data|safe }}');
		const stockLabels = JSON.parse('{{ stock_labels|safe }}');
		const stockData = JSON.parse('{{ stock_data|safe }}');
		const predictionsData = JSON.parse('{{ predictions_data|safe }}');
		
		console.log("Sales Labels:", salesLabels);
		console.log("Sales Data:", salesData);
		console.log("Stock Labels:", stockLabels);
		console.log("Stock Data:", stockData);
		console.log("Predictions Data:", predictionsData);

		// Define charts as global variables
		let combinedSalesChart, stockChart;

		window.onload = function() {
			initializeCombinedSalesChart();
			initializeStockChart();
		};

		// Combined Sales and Predictions Chart
		function initializeCombinedSalesChart() {
			const combinedSalesCtx = document.getElementById('combinedSalesChart').getContext('2d');
			console.log("Initializing combinedSalesChart");
			combinedSalesChart = new Chart(combinedSalesCtx, {
				type: 'line',
				data: {
					labels: salesLabels,
					datasets: [
						{
							label: 'Actual Sales',
							data: salesData,
							backgroundColor: 'rgba(54, 162, 235, 0.2)',
							borderColor: 'rgba(54, 162, 235, 1)',
							borderWidth: 2,
							pointRadius: 4,
							fill: true
						},
						{
							label: 'Sales Baseline',
							data: predictionsData,
							backgroundColor: 'rgba(255, 159, 64, 0.2)',
							borderColor: 'rgba(255, 159, 64, 1)',
							borderWidth: 2,
							pointRadius: 4,
							fill: true
						}
					]
				},
				options: {
					responsive: true,
					plugins: {
						legend: {
							position: 'top',
							labels: {
								color: '#333',
								font: {
									size: 14,
									weight: 'bold'
								}
							}
						},
						tooltip: { enabled: true }
					},
					scales: {
						responsive: true,
						x: {
							title: { display: true, text: 'Date', color: '#666' },
							ticks: { color: '#333' }
						},
						y: {
							title: { display: true, text: 'Sales Amount', color: '#666' },
							beginAtZero: true,
							ticks: { color: '#333' }
						}
					}
				}
			});
		}

		// Stock Chart
		function initializeStockChart() {
			const stockCtx = document.getElementById('stockChart').getContext('2d');
			console.log("Initializing stockChart");
			stockChart = new Chart(stockCtx, {
				type: 'bar',
				data: {
					labels: stockLabels,
					datasets: [{
						label: 'Stock Levels',
						data: stockData,
						backgroundColor: 'rgba(153, 102, 255, 0.2)',
						borderColor: 'rgba(153, 102, 255, 1)',
						borderWidth: 1,
					}]
				},
				options: {
					responsive: true,
					plugins: {
						legend: { position: 'top' },
						tooltip: { enabled: true }
					},
					indexAxis: 'y',
					scales: {
						x: {
							beginAtZero: true,
							ticks: { color: '#333' },
							title: { display: true, text: 'Stock Quantity', color: '#666' }
						},
						y: {
							ticks: { color: '#333' }
						}
					}
				}
			});
		}
		
		// Toggle navigation menu
		function toggleNav() {
			const nav = document.querySelector('.dashboard-nav');
			const content = document.querySelector('.content');
			nav.classList.toggle('collapsed');
			content.classList.toggle('collapsed');
		}

		// Filter charts by date using AJAX
		function filterCharts() {
			const startDate = document.getElementById('start_date').value;
			const endDate = document.getElementById('end_date').value;

			if (startDate && endDate) {
				fetch(`/sales/filter-data/?start_date=${startDate}&end_date=${endDate}`)
					.then(response => response.json())
					.then(data => {
						console.log("Filtered Data Response:", data);
						
						if (data.sales_labels && data.sales_data && data.predictions_data) {
							console.log("Sales Labels:", data.sales_labels);
							console.log("Sales Data:", data.sales_data);
							console.log("Predictions Data:", data.predictions_data);
							
							updateCombinedChart(data.sales_labels, data.sales_data, data.predictions_data);
						} else {
							console.warn("No data returned for the selected date range.");
						}
					})
					.catch(error => {
						console.error('Error fetching filtered data:', error);
					});
			} else {
				alert("Please select a valid date range.");
			}
		}
		
		// Update chart data with new filtered data
		function updateCombinedChart(newSalesLabels, newSalesData, newPredictionsData) {
			console.log("Updating combined chart with:");
		    console.log("Updating chart with labels:", newSalesLabels);  // Log updated labels
			console.log("Updating chart with sales data:", newSalesData);  // Log updated sales data
			console.log("Updating chart with predictions data:", newPredictionsData);  // Log updated predictions data

			// Reset labels and datasets
			combinedSalesChart.data.labels.length = 0;
			combinedSalesChart.data.datasets.forEach(dataset => dataset.data.length = 0);

			// Update combined Sales and Predictions chart
			combinedSalesChart.data.labels = newSalesLabels;
			combinedSalesChart.data.datasets[0].data = newSalesData;
			combinedSalesChart.data.datasets[1].data = newPredictionsData;
			combinedSalesChart.update();
		}
		
	</script>

    <style>
        /* Set up the layout using flexbox */
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

        .dashboard-container {
            display: flex !important;
			flex-direction: row !important;
            min-height: 100vh !important;
            width: 100% !important;
            overflow: hidden !important;  /* Prevent overflow */
        }

        /* Preserve the original theme for the navigation */
        .dashboard-nav {
            width: 250px !important;
            background-color: #607d8b !important;  /* Keep your original navigation color */
            color: #fff !important;  /* White text */
            transition: width 0.3s ease !important;  /* Smooth transition */
            padding: 20px 0 !important;
        }

        /* Collapsed navigation */
        .dashboard-nav.collapsed {
            width: 60px !important;  /* Shrink the width */
			transform: translateX(0) !important;
        }

        /* Hide Submenus by Default */
        .dashboard-nav ul ul {
            display: block; !important;
            margin-top: 10px !important;
            padding-left: 15px !important;
        }

        .dashboard-nav ul li:hover ul {
            display: block !important;
        }

        /* Preserve the theme of the toggle button */
        .toggle-btn {
            position: fixed !important;
            top: 20px !important;
            left: 275px !important;
            width: 40px !important;
            height: 40px !important;
            background-color: #607d8b !important;  /* Original button color */
            color: #fff !important;
            border: none !important;
            cursor: pointer !important;
            transition: left 0.3s ease !important;
            border-radius: 20% !important;
            z-index: 1000 !important;
        }

        /* Move toggle button when navigation is collapsed */
        .dashboard-nav.collapsed ~ .toggle-btn {
            left: 85px !important;  /* Adjusted to fit the collapsed nav */
        }

        /* Content area */
        .content {
            flex-grow: 1 !important;
            padding: 20px !important;
			margin-left: 250px !important;  /* Match expanded nav width */
            transition: margin-left 0.3s ease !important;
            background-color: #f4f4f4 !important;  /* Match your theme */
        }

        /* Content adjustment when navigation is collapsed */
        .content.collapsed {
            margin-left: 60px !important;  /* Reduced margin */
        }


        /* Adjust button hover effect */
        .toggle-btn:hover {
            background-color: #546e7a !important;  /* Darker on hover */
        }

        /* Flexbox Layout for Charts */
        .charts-container {
            display: flex !important;
			flex-direction: column !important;
            flex-wrap: wrap !important;
            gap: 20px !important;
        }

		.chart-container {
			background-color: #f9f9f9;
			padding: 15px;
			border-radius: 8px;
			box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
		}

        .chart {
            flex: 1 1 calc(33.333% - 20px) !important;
            background-color: #f4f4f4 !important;  /* Original theme */
            padding: 15px !important;
            border-radius: 10px !important;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1) !important;
        }

		.chart-header {
			font-size: 18px;
			font-weight: bold;
			text-align: center;
			margin-bottom: 10px;
			color: #333;
		}

		/* Responsive Adjustments */
		@media (max-width: 768px) {
			.dashboard-nav {
				width: 100%; /* Full width for mobile */
				transform: translateX(-100%); /* Initially hidden */
			}

			.dashboard-nav.collapsed {
				transform: translateX(0); /* Slide in */
			}

			.content {
				margin-left: 0; /* Reset offset for mobile */
			}

			.dashboard-nav.collapsed ~ .content {
				margin-left: 0; /* No offset for expanded nav in mobile */
			}
		}


        /* Toggle Button */
        .toggle-btn {
            position: fixed !important;
            top: 20px !important;
            left: 275px !important;
            width: 40px !important;
            height: 40px !important;
            background-color: #607d8b !important;
            color: #fff !important;
            border: none !important;
            cursor: pointer !important;
            z-index: 1001 !important;
            transition: left 0.3s ease !important;
        }

        .dashboard-nav.collapsed ~ .toggle-btn {
            left: 20px !important;
        }

        /* Content */
        .content {
            flex-grow: 1 !important;
            padding: 20px !important;
            transition: margin-left 0.3s ease !important;
            background-color: #f4f4f4 !important;
        }

        /* Full-width charts on mobile */
        .charts-container {
            display: flex !important;
            flex-wrap: wrap !important;
            gap: 20px !important;
        }

        .chart {
            flex: 1 1 calc(33.333% - 20px) !important;
            background-color: #f4f4f4 !important;
            padding: 15px !important;
            border-radius: 10px !important;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1) !important;
        }

        @media (max-width: 768px) {
            .chart {
                flex: 1 1 100% !important;
            }
        }

		/* Date filter styling */
		.date-filters {
			display: flex !important;
 			justify-content: space-between !important;
			margin-bottom: 20px !important;
		}

		.date-filters input[type="date"] {
			padding: 8px !important;
			border: 1px solid #ccc !important;
			border-radius: 4px !important;
			font-size: 16px !important;
		}

		.date-filters button {
			background-color: #607d8b !important;
			color: #fff !important;
			padding: 8px 16px !important;
			border: none !important;
			border-radius: 4px !important;
			cursor: pointer !important;
		}

		.date-filters button:hover {
			background-color: #546e7a !important;
		}

		.date-filters button:hover {
			background-color: #546e7a !important;
		}

		.subscription-details {
			font-size: 0.9rem; /* Smaller font size */
			line-height: 1.4; /* Adjust spacing between lines */
			color: #555; /* Muted color for less emphasis */
			margin-top: 10px; /* Small gap from the heading */
		}

		.subscription-details p {
			margin: 2px 0; /* Reduce spacing between paragraphs */
		}

		.subscription-details strong {
			color: #333; /* Slightly bolder for key terms */
		}
    </style>
	
</head>
	<body>
		<div class="dashboard-container">
			<!-- Navigation bar -->
			<nav class="dashboard-nav">
				<ul>
					<!-- Reports Menu -->
					<li>
						<a href="#">Reports</a>
						<ul>
							<li><a href="{% url 'sales-list' %}">Detailed Sales</a></li>
							<li><a href="{% url 'financial-summary' %}">Financial Summary</a></li>
							<li><a href="#">Staff Summary</a></li>
							<li><a href="#">Other Reports</a></li>
						</ul>
					</li>

					<!-- Stock & Sales Menu -->
					<li>
						<a href="#">Stock & Sales</a>
						<ul>
							<li><a href="{% url 'add-stock' %}">Update Stock</a></li>
							<li><a href="{% url 'stock-list' %}">Update Selling price</a></li>
							<li><a href="{% url 'create-sale' %}">Transact Sale</a></li>
							<li><a href="{% url 'pending-sales' %}">Resume Sale</a></li>
							<li><a href="{% url 'stock-list' %}">Set Prices</a></li>
						</ul>
					</li>

					<!-- Users & User Roles Menu -->
					<li>
						<a href="#">Users & User Roles</a>
						<ul>
							<li><a href="{% url 'profile' %}">User Profile</a></li>
							<li><a href="#">Add User</a></li>
							<li><a href="#">Deactivate / Activate User</a></li>
							<li><a href="#">Process Salaries / Commissions</a></li>
						</ul>
					</li>

					<!-- Logout -->
					<li>
						<form id="logout-form" action="{% url 'logout' %}" method="post" style="display:none;">
							{% csrf_token %}
							<button type="submit">Logout</button>
						</form>
						<a href="#" onclick="event.preventDefault(); document.getElementById('logout-form').submit();">Logout</a>
					</li>
				</ul>
			</nav>
			<!-- Main Content Area -->
			<div class="content">
				<h1>____Welcome to DigiServe!___</h1>
				<p>___A Digital cloud base Point of Sale system.</p>

				<h2>{{ request.user.business.name }}</h2>
				<div class="subscription-details">
					<p>Subscription Plan: {{ request.user.business.subscription_plan.subscription_type }}</p>
					<p>Subscription Expiry: {{ request.user.business.subscription_expiry|date:"Y-m-d H:i" }}</p>
					<p>Details: {{ request.user.business.subscription_plan.description }}</p>
					<p>Cost: {{ request.user.business.subscription_plan.amount }} {{ request.user.business.subscription_plan.currency }}</p>
					<p>Frequency: {{ request.user.business.subscription_plan.frequency }}</p>
				</div>

					<div class="date-filters">
						<div>
							<label for="start_date">Start Date:</label>
							<input type="date" id="start_date" name="start_date">
						</div>
						<br>
						<div>
							<label for="end_date">End Date:</label>
							<input type="date" id="end_date" name="end_date">
						</div>
						<br>
						<div><button onclick="filterCharts()">Filter</button></div>
					</div>	
					
				<!-- Charts Container -->					
				<div class="charts-container">
					<!-- Combined Sales and Predictions Chart -->		
					<div class="chart-container">					
						<h3 class="chart-header">Sales Overview & Baseline</h3>
						<canvas id="combinedSalesChart"></canvas>
					</div>
					
					<!-- Stock Levels Chart -->
					<div class="chart-container">
						<h3 class="chart-header">Stock Levels</h3>
						<canvas id="stockChart"></canvas>
					</div>
				</div>
				<!-- Toggle Button -->
				<button class="toggle-btn" onclick="toggleNav()">☰</button>
			</div>
		</div>
	</body>
</html>